@page "/"
@using JGUZDV.Blazor.Components.Toasts
@using JGUZDV.DynamicForms.Model
@using System.Text.Json
@using JGUZDV.DynamicForms.Serialization
@using JGUZDV.L10n

<PageTitle>Home</PageTitle>

<h1>Hello, world!</h1>

Welcome to your new app.

<JGUZDV.DynamicForms.Blazor.EditFieldDefinition @bind-FieldDefinition="_fieldDefinition">

</JGUZDV.DynamicForms.Blazor.EditFieldDefinition>

<button @onclick="Send">send</button>


@code {
    private FieldDefinition _fieldDefinition = new();


    [Inject]
    public required IServiceProvider ServiceProvider { get; set; }

    [Inject]
    public required IToastService Toasts { get; set; }

    [Inject]
    public required HttpClient Client { get; set; }

    private async Task Send()
    {
        if (_fieldDefinition.Validate(new(_fieldDefinition, ServiceProvider, null)).Any())
        {
            Toasts.Show(ToastLevel.Warning, "Validation failed", "");
            return;
        }

        var options = new JsonSerializerOptions()
            {
                TypeInfoResolver = new DefaultResolver(),
                PropertyNameCaseInsensitive = true
            };
        options.Converters.Add(new L10nStringJsonConverter());

        await Client.PostAsJsonAsync("https://localhost:7245/api/definitions/save", _fieldDefinition, options);
        _fieldDefinition = new FieldDefinition();
    }

}