@typeparam T
@typeparam TKey

@using Microsoft.AspNetCore.Components.Web;

<div class="@(Class == null ? "px-2 py-1 border" : $"{Class}")">
    <div class="d-flex justify-content-between" role="button" style="cursor:pointer" @onclick="ToggleSelection">
        <div class="d-flex flex-nowrap overflow-hidden text-nowrap text-truncate">
            <span class="me-1">@Title </span>
            @if (!IsSingle && Values!.Any())
            {
                <span class="text-muted small text-truncate align-self-center" title="@(Values!.Select(x => ItemName(x)).Aggregate((a,b) => $"{a}, {b}"))">
                    <span> (@Values!.Select(x => ItemName(x)).Aggregate((a,b) => $"{a}, {b}"))</span>
                </span>
            }
            else if (Value != null && IsSingle)
            {
                <span class="text-muted small text-truncate align-self-center" title="@ItemName(Value)">
                    <span> (@ItemName(Value))</span>
                </span>
            }
        </div>
        <div class="ms-1">
            @if (_isOpen)
            {
                <i class="fa fa-fw fa-minus align-self-center"></i>
            }
            else
            {
                <i class="fa fa-fw fa-plus align-self-center"></i>
            }
        </div>
    </div>

    @if (_isOpen)
    {
        <div class="fade-in">
            <MultiSelectBody Items="@Items"
                             Values="@Values"
                             ValuesChanged="@ValuesChanged"
                             Value="@Value"
                             ValueChanged="@ValueChanged"
                             FilterLabel="@FilterLabel"
                             RowCols="@RowCols"
                             ItemKey="@ItemKey"
                             ItemName="@ItemName"
                             AllOptionLabel="@AllOptionLabel"
                             IsSingle="@IsSingle"
                             T="T"
                             TKey="TKey">
            </MultiSelectBody>
        </div>
    }
</div>
@code {
    [Parameter]
    [EditorRequired]
    public List<T> Items { get; set; } = default!;

    [Parameter]
    [EditorRequired]
    public Func<T, string> ItemName { get; set; } = default!;

    [Parameter]
    [EditorRequired]
    public Func<T, TKey> ItemKey { get; set; } = default!;

    [Parameter]
    public List<T>? Values { get; set; } = default!;

    [Parameter]
    public EventCallback<List<T>> ValuesChanged { get; set; }

    [Parameter]
    public T? Value { get; set; } = default!;

    [Parameter]
    public EventCallback<T> ValueChanged { get; set; }

    [Parameter]
    [EditorRequired]
    public string Title { get; set; } = default!;

    [Parameter]
    public string? AllOptionLabel { get; set; }

    [Parameter]
    public string? Class { get; set; }

    [Parameter]
    public string? FilterLabel { get; set; }

    [Parameter]
    public string? RowCols { get; set; } = "row-cols-1";

    [Parameter]
    public bool IsSingle { get; set; }

    private bool _isOpen;

    private string? _filter;

    protected override void OnParametersSet()
    {
        base.OnParametersSet();

        if (Value != null && Values != null)
            throw new InvalidOperationException("Single and Multiple does not work simultaneously");

        if (!IsSingle && Values == null)
            throw new InvalidOperationException($"Parameter {nameof(Values)} may not be null if multipe values are allowed");

        if (IsSingle && Values != null)
            throw new InvalidOperationException($"Parameter {nameof(Values)} may not be set if only one value is allowed");
    }

    private void ToggleSelection()
    {
        _isOpen = !_isOpen;
    }
}
